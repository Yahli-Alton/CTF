/* This file was generated by the Hex-Rays decompiler version 8.3.0.230608.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <stdio.h>


//-------------------------------------------------------------------------
// Function declarations

__int64 (**init_proc())(void);
void sub_1020();
void sub_1030();
void sub_1040();
void sub_1050();
void sub_1060();
void sub_1070();
void sub_1080();
// int __fastcall _cxa_finalize(void *);
// int puts(const char *s);
// size_t strlen(const char *s);
// int printf(const char *format, ...);
// void *memset(void *s, int c, size_t n);
// __int64 __isoc99_scanf(const char *, ...); weak
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)(void));
char *deregister_tm_clones();
__int64 register_tm_clones();
char *_do_global_dtors_aux();
__int64 frame_dummy(); // weak
__int64 xorshift128();
__int64 __fastcall check_key(const char *a1);
int __fastcall main(int argc, const char **argv, const char **envp);
__int64 __fastcall hash_64_fnv1a(__int64 a1, unsigned __int64 a2);
void term_proc();
// int __fastcall _libc_start_main(int (__fastcall *main)(int, char **, char **), int argc, char **ubp_av, void (*init)(void), void (*fini)(void), void (*rtld_fini)(void), void *stack_end);
// int __fastcall __cxa_finalize(void *);
// __int64 _gmon_start__(void); weak

//-------------------------------------------------------------------------
// Data declarations

void *_dso_handle = &_dso_handle; // idb
char _bss_start; // weak
int x; // weak
int y; // weak
int z; // weak
int w; // weak


//----- (0000000000001000) ----------------------------------------------------
__int64 (**init_proc())(void)
{
  __int64 (**result)(void); // rax

  result = &_gmon_start__;
  if ( &_gmon_start__ )
    return (__int64 (**)(void))_gmon_start__();
  return result;
}
// 4078: using guessed type __int64 _gmon_start__(void);

//----- (0000000000001020) ----------------------------------------------------
void sub_1020()
{
  JUMPOUT(0LL);
}
// 1026: control flows out of bounds to 0

//----- (0000000000001030) ----------------------------------------------------
void sub_1030()
{
  sub_1020();
}

//----- (0000000000001040) ----------------------------------------------------
void sub_1040()
{
  sub_1020();
}

//----- (0000000000001050) ----------------------------------------------------
void sub_1050()
{
  sub_1020();
}

//----- (0000000000001060) ----------------------------------------------------
void sub_1060()
{
  sub_1020();
}

//----- (0000000000001070) ----------------------------------------------------
void sub_1070()
{
  sub_1020();
}

//----- (0000000000001080) ----------------------------------------------------
void sub_1080()
{
  sub_1020();
}

//----- (0000000000001100) ----------------------------------------------------
// positive sp value has been detected, the output may be wrong!
void __fastcall __noreturn start(__int64 a1, __int64 a2, void (*a3)(void))
{
  __int64 v3; // rax
  int v4; // esi
  __int64 v5; // [rsp-8h] [rbp-8h] BYREF
  char *retaddr; // [rsp+0h] [rbp+0h] BYREF

  v4 = v5;
  v5 = v3;
  _libc_start_main((int (__fastcall *)(int, char **, char **))main, v4, &retaddr, 0LL, 0LL, a3, &v5);
  __halt();
}
// 110A: positive sp value 8 has been found
// 1111: variable 'v3' is possibly undefined

//----- (0000000000001130) ----------------------------------------------------
char *deregister_tm_clones()
{
  return &_bss_start;
}
// 4010: using guessed type char _bss_start;

//----- (0000000000001160) ----------------------------------------------------
__int64 register_tm_clones()
{
  return 0LL;
}

//----- (00000000000011A0) ----------------------------------------------------
char *_do_global_dtors_aux()
{
  char *result; // rax

  if ( !_bss_start )
  {
    if ( &__cxa_finalize )
      _cxa_finalize(_dso_handle);
    result = deregister_tm_clones();
    _bss_start = 1;
  }
  return result;
}
// 4010: using guessed type char _bss_start;

//----- (00000000000011E0) ----------------------------------------------------
__int64 frame_dummy()
{
  return register_tm_clones();
}
// 11E0: using guessed type __int64 frame_dummy();

//----- (00000000000011E9) ----------------------------------------------------
__int64 xorshift128()
{
  unsigned int v1; // [rsp+0h] [rbp-4h]

  v1 = (((x << 11) ^ (unsigned int)x) >> 8) ^ (x << 11) ^ x;
  x = y;
  y = z;
  z = w;
  w ^= (unsigned int)w >> 19;
  w ^= v1;
  return (unsigned int)w;
}
// 4014: using guessed type int x;
// 4018: using guessed type int y;
// 401C: using guessed type int z;
// 4020: using guessed type int w;

//----- (0000000000001260) ----------------------------------------------------
__int64 __fastcall check_key(const char *input)
{
  __int64 v2; // rbx
  unsigned int i; // [rsp+18h] [rbp-258h]
  unsigned int j; // [rsp+1Ch] [rbp-254h]
  unsigned int k; // [rsp+20h] [rbp-250h]
  unsigned int m; // [rsp+24h] [rbp-24Ch]
  unsigned int n; // [rsp+28h] [rbp-248h]
  unsigned int ii; // [rsp+2Ch] [rbp-244h]
  __int64 hashes[22]; // [rsp+30h] [rbp-240h] BYREF
  __int64 res[22]; // [rsp+E0h] [rbp-190h] BYREF
  __int64 needed[22]; // [rsp+190h] [rbp-E0h]
  char alphabet[24]; // [rsp+240h] [rbp-30h] BYREF
  unsigned __int64 v13; // [rsp+258h] [rbp-18h]

  v13 = __readfsqword(0x28u);
  if ( strlen(input) != 84 )
    return 0LL;
  strcpy(alphabet, "!_acdefghilmnoprstuwy");
  for ( i = 0; i <= 0x53; ++i )
  {
    for ( j = 0; j <= 0x14 && alphabet[j] != input[i]; ++j )
    {
      if ( j == 20 )
        return 0LL;
    }
  }
  memset(hashes, 0, 0xA8uLL);
  for ( k = 0; k <= 0x14; ++k )
    hashes[k] = (int)hash_64_fnv1a((__int64)&input[4 * k], 4uLL);
  x = 123456789;
  y = 362436069;
  z = 521288629;
  w = -559038737;
  memset(res, 0, 0xA8uLL);
  for ( m = 0; m <= 0x14; ++m )
  {
    for ( n = 0; n <= 0x14; ++n )
    {
      v2 = hashes[n];
      res[m] += (int)xorshift128() % 1024 * v2;
    }
  }
  needed[0] = 0xFFFFFF6F11B8034BLL;
  needed[1] = 0x673420DAF2LL;
  needed[2] = 0x45EB817F02CLL;
  needed[3] = 0xFFFFFE3099503945LL;
  needed[4] = 0x18F8DCE1227LL;
  needed[5] = 0x26050EA6875LL;
  needed[6] = 0x298599C4BF0LL;
  needed[7] = 0xFFFFF8A356CE9E58LL;
  needed[8] = 0xFFFFFED3C712CF36LL;
  needed[9] = 0xFFFFFE96846D630FLL;
  needed[10] = 0x58CB1CE3FF3LL;
  needed[11] = 0xFFFFFCCF182C2A63LL;
  needed[12] = 0xFFFFFE57FDF3F1DELL;
  needed[13] = 0xFFFFFA603F35F962LL;
  needed[14] = 0xFFFFFF7884570B57LL;
  needed[15] = 0x4897C4D9C1LL;
  needed[16] = 0xFFFFFEB9355E5CB4LL;
  needed[17] = 0xDCEDF7D094LL;
  needed[18] = 0x3602E9CAC47LL;
  needed[19] = 0xFFFFFEE3667219D6LL;
  needed[20] = 0xFFFFFDC326C9B063LL;
  for ( ii = 0; ii <= 0x14; ++ii )
  {
    if ( needed[ii] != res[ii] )
      return 0LL;
  }
  return 1LL;
}
// 4014: using guessed type int x;
// 4018: using guessed type int y;
// 401C: using guessed type int z;
// 4020: using guessed type int w;
// 1260: using guessed type __int64 var_240[22];
// 1260: using guessed type __int64 var_190[22];

//----- (000000000000161D) ----------------------------------------------------
int __fastcall main(int argc, const char **argv, const char **envp)
{
  char s[104]; // [rsp+0h] [rbp-70h] BYREF
  unsigned __int64 v6; // [rsp+68h] [rbp-8h]

  v6 = __readfsqword(0x28u);
  memset(s, 0, 0x64uLL);
  printf("Please enter your key: ");
  __isoc99_scanf("%84s", s);
  if ( (unsigned __int8)check_key(s) )
    printf("Correct. Your flag is TetCTF{%s}\n", s);
  else
    puts("Wrong");
  return v6 - __readfsqword(0x28u);
}
// 10F0: using guessed type __int64 __isoc99_scanf(const char *, ...);

//----- (00000000000016D0) ----------------------------------------------------
__int64 __fastcall hash_64_fnv1a(__int64 a1, unsigned __int64 a2)
{
  int i; // [rsp+14h] [rbp-1Ch]
  __int64 v4; // [rsp+18h] [rbp-18h]

  v4 = 0xCBF29CE484222325LL;
  for ( i = 0; a2 > i; ++i )
    v4 = 0x100000001B3LL * (*(unsigned __int8 *)(i + a1) ^ (unsigned __int64)v4);
  return v4;
}

//----- (000000000000174C) ----------------------------------------------------
void term_proc()
{
  ;
}

// nfuncs=34 queued=18 decompiled=18 lumina nreq=0 worse=0 better=0
// ALL OK, 18 function(s) have been successfully decompiled
